version: "3"

services:
  mysql-db:
    image: mysql
    environment:
      - MYSQL_DATABASE=testing-db
      - MYSQL_USER=autotest
      - MYSQL_PASSWORD=autotest
    volumes:
    - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
  application:
    build:
      context: ../.
      args:
        - http_proxy=${HTTP_PROXY}
        - https_proxy=${HTTPS_PROXY}
    image: application
    command: ["./wait-for-it.sh", "mysql-db:3306", "--", "npm", "start"]
    depends_on:
      - mysql-db
    environment:
      - DB_USERNAME=autotest
      - DB_PASSWORD=autotest
      - DB_NAME=testing-db
      - DB_HOST=mysql-db
      - DB_PORT=3306
  test-application:
    build: 
      context: .
      args:
          - http_proxy=${HTTP_PROXY}
          - https_proxy=${HTTPS_PROXY}
    image: api-automation-testing
    command: ["./wait-for-it.sh", "application:3000", "--", "npm", "start"]
    depends_on:
      - mysql-db
      - application
    environment:
      - SERVER_ENDPOINT=application:3000
      - DB_URI=http://autotest:autotest@mysql-db:5432/testing-db
      - MOCHAWESOME_REPORTFILENAME=report
    volumes: 
      - ${REPORT_DIR}:/var/opt/automation-testing/report
      - ${REPORT_DIR}:/var/opt/automation-testing/logs